name: Database Backup to Google Cloud Storage

on:
  schedule:
    - cron: '0 0 * * *' # Runs daily at midnight UTC
  workflow_dispatch: # Allows manual trigger from GitHub UI

jobs:
  backup:
    runs-on: ubuntu-latest
    
    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install PostgreSQL Client
      run: |
        sudo apt-get update
        sudo apt-get install -y postgresql-client

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2

    - name: Create Database Dump
      env:
        DATABASE_URL: ${{ secrets.DATABASE_URL }}
      run: |
        # Use pg_dump to create a compressed custom-format archive
        # This format is smaller and allows selective restore
        pg_dump "$DATABASE_URL" -F c -f backup_$(date +%Y-%m-%d_%H-%M-%S).dump

    - name: Upload to Google Cloud Storage
      run: |
        # Upload the dump file to the specified GCS bucket
        gcloud storage cp backup_*.dump gs://${{ secrets.GCP_BACKUP_BUCKET }}/backups/
