// Datasource configuration
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DATABASE_URL_UNPOOLED")
}

// Core Models based on PLAN.md architecture

// Library/Tenant (Multi-tenant root entity)
model Library {
  id        String   @id @default(uuid())
  name      String
  subdomain String   @unique // For multi-tenant URL routing
  logo      String?
  website   String?
  contactEmail String?
  contactPhone String?
  address   String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relationships
  owners    Owner[]
  branches  Branch[]
  plans     Plan[]
  staff     Staff[]
  staffActivities StaffActivity[]
  staffAttendance StaffAttendance[]
  staffShifts     StaffShift[]
  students        Student[]
  subscriptions   StudentSubscription[]
  seats           Seat[]
  attendance      Attendance[]
  payments        Payment[]
  studentWallets  StudentWallet[]
  walletTransactions WalletTransaction[]
  promotions      Promotion[]
  supportTickets  SupportTicket[]
  ticketComments  TicketComment[]
  announcements   Announcement[]
  studentGoals    StudentGoal[]
  focusSessions   FocusSession[]
  additionalFees  AdditionalFee[]
  studentNotes    StudentNote[]
  referrals       Referral[]
  referralSettings Json?     // Configuration for referral program
  
  @@map("libraries")
}

// Library Owner (Associated with specific Library)
model Owner {
  id        String   @id @default(uuid())
  libraryId String
  name      String
  email     String   @unique
  phone     String?
  username  String?  @unique
  password  String?
  image     String?
  address   String?
  bio       String?
  socialLinks String?
  preferences String?
  twoFactorSecret String?
  twoFactorEnabled Boolean @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relationships
  library   Library  @relation(fields: [libraryId], references: [id], onDelete: Cascade)
  branches  Branch[]
  
  @@map("owners")
}

// Library Branch (Owned by Library, managed by Owner)
model Branch {
  id          String   @id @default(uuid())
  libraryId   String
  ownerId     String?
  name        String
  address     String
  city        String
  state       String
  pincode     String
  contactPhone String?
  contactEmail String?
  managerName  String?
  seatCount    Int      @default(0)
  area         String?
  description  String?
  mapsLink     String?
  images       String?  // JSON array
  wifiDetails  String?  // JSON structure
  operatingHours String? // JSON structure for hours
  amenities    String?   // JSON structure for amenities
  qrCode       String?   @unique // Unique token for QR code attendance
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  // Relationships
  library     Library  @relation(fields: [libraryId], references: [id], onDelete: Cascade)
  owner       Owner?    @relation(fields: [ownerId], references: [id], onDelete: SetNull)
  staff       Staff[]
  students    Student[]
  seats       Seat[]
  subscriptions StudentSubscription[]
  attendance    Attendance[]
  plans         Plan[]
  staffShifts   StaffShift[]
  staffAttendance StaffAttendance[]
  additionalFees AdditionalFee[]
  promotions    Promotion[]
  payments      Payment[]
  supportTickets SupportTicket[]
  
  @@map("branches")
}

// Staff Member (Associated with specific Branch)
model Staff {
  id        String   @id @default(uuid())
  libraryId String
  branchId  String
  name      String
  email     String   @unique
  phone     String?
  address   String?
  image     String?  // Profile picture URL
  salary    Float?
  joiningDate DateTime?
  dob       DateTime?
  gender    String?
  employmentType String? // 'full_time', 'part_time', 'contract'
  password  String?  // Hashed password
  username  String?  @unique
  status    String   @default("active") // 'active', 'on_leave', 'inactive'
  documents String?    // Array of { name, url, type, size }
  role      String   // 'manager', 'assistant', 'support'
  permissions String?  // JSON structure for role permissions
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relationships
  library   Library  @relation(fields: [libraryId], references: [id], onDelete: Cascade)
  branch     Branch   @relation(fields: [branchId], references: [id], onDelete: Cascade)
  activities StaffActivity[]
  attendance StaffAttendance[]
  shifts     StaffShift[]
  supportTickets SupportTicket[]
  
  @@map("staff")
}

model StaffActivity {
  id        String   @id @default(uuid())
  libraryId String
  staffId   String
  type      String   // 'create', 'update', 'delete', 'payment', 'issue', 'login'
  action    String
  details   String?
  entity    String   // 'Student Management', 'Finance', etc.
  status    String   // 'success', 'warning', 'error', 'pending'
  metadata  String?
  createdAt DateTime @default(now())

  // Relationships
  library   Library  @relation(fields: [libraryId], references: [id], onDelete: Cascade)
  staff     Staff    @relation(fields: [staffId], references: [id], onDelete: Cascade)

  @@map("staff_activities")
}

// Student (Independent - can subscribe to multiple branches)
model Student {
  id        String   @id @default(uuid())
  name      String
  email     String   @unique
  phone     String?
  password  String?
  
  // Profile Extensions
  image         String?
  dob           DateTime?
  gender        String?
  
  // Address
  address       String?
  area          String?
  city          String?
  state         String?
  pincode       String?
  
  // Guardian
  guardianName  String?
  guardianPhone String?

  // Origin/Home Context (for multi-tenancy)
  libraryId     String?
  branchId      String?
  library       Library? @relation(fields: [libraryId], references: [id])
  branch        Branch?  @relation(fields: [branchId], references: [id])

  // Govt ID Verification
  govtIdUrl     String?
  govtIdStatus  String   @default("none") // 'none', 'pending', 'verified', 'rejected'
  
  // Account Status
  isBlocked     Boolean  @default(false)
  preferences   Json?    // User preferences (notifications, theme, etc.)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relationships
  subscriptions StudentSubscription[]
  attendance    Attendance[]
  payments      Payment[]
  wallets       StudentWallet[]
  supportTickets SupportTicket[]
  goals         StudentGoal[]
  focusSessions FocusSession[]
  likedQuotes   LikedQuote[]
  notes         StudentNote[]
  
  // Referrals
  referralCode  String?  @unique
  sentReferrals Referral[] @relation("Referrer")
  receivedReferral Referral? @relation("Referee")

  @@map("students")
}

// Referral System
model Referral {
  id          String   @id @default(uuid())
  libraryId   String
  referrerId  String   // Student who referred
  refereeId   String   @unique // Student who was referred
  status      String   @default("pending") // 'pending', 'completed' (referee paid), 'redeemed' (referrer used coupon)
  
  // Rewards Details
  referrerCouponCode String? // Generated one-time coupon for referrer
  refereeDiscount    Float?  // Discount amount given to referee
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  library     Library @relation(fields: [libraryId], references: [id], onDelete: Cascade)
  referrer    Student @relation("Referrer", fields: [referrerId], references: [id], onDelete: Cascade)
  referee     Student @relation("Referee", fields: [refereeId], references: [id], onDelete: Cascade)

  @@map("referrals")
}

model StudentNote {
  id        String   @id @default(uuid())
  studentId String
  libraryId String
  content   String
  createdBy String?  // "Owner" or "Staff: {name}"
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  student   Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  library   Library  @relation(fields: [libraryId], references: [id], onDelete: Cascade)

  @@map("student_notes")
}

model LikedQuote {
  id        String   @id @default(uuid())
  studentId String
  quoteId   Int
  createdAt DateTime @default(now())

  student   Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([studentId, quoteId])
  @@map("liked_quotes")
}

// Subscription Plan (Defined by Library/Branch)
model Plan {
  id          String   @id @default(uuid())
  libraryId   String
  branchId    String?  // Null if plan is global for library (optional)
  name        String
  description String?
  price       Float
  duration    Int      // value
  durationUnit String  @default("months") // 'days', 'months'
  category     String  @default("fixed")  // 'fixed', 'flexible'
  billingCycle String  @default("per_month") // 'per_month', 'one_time'
  hoursPerDay  Float?  // For flexible plans
  shiftStart   String? // For fixed plans
  shiftEnd     String? // For fixed plans
  type        String?  // 'monthly', 'quarterly', 'yearly', 'custom' - Deprecated in favor of new structure
  features    String?  // JSON list of features
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relationships
  library     Library  @relation(fields: [libraryId], references: [id], onDelete: Cascade)
  branch      Branch?  @relation(fields: [branchId], references: [id], onDelete: Cascade)
  subscriptions StudentSubscription[]
  promotions  Promotion[]
  
  @@map("plans")
}

// Additional Fee (Defined by Library/Branch)
model AdditionalFee {
  id          String   @id @default(uuid())
  libraryId   String
  branchId    String?  // Null if global
  name        String
  description String?
  amount      Float
  type        String   // 'one_time', 'monthly'
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relationships
  library     Library  @relation(fields: [libraryId], references: [id], onDelete: Cascade)
  branch      Branch?  @relation(fields: [branchId], references: [id], onDelete: Cascade)
  payments    Payment[]

  @@map("additional_fees")
}

// Student Subscription (Active/Past plans)
model StudentSubscription {
  id        String   @id @default(uuid())
  libraryId String
  branchId  String
  studentId String
  planId    String
  startDate DateTime
  endDate   DateTime
  status    String   // 'active', 'expired', 'cancelled', 'pending'
  amountPaid Float
  discount  Float?
  finalAmount Float?
  paymentStatus String // 'paid', 'partial', 'pending'
  seatId    String?  // Optional seat assignment
  shiftId   String?  // Optional shift assignment (if shifts are strict)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relationships
  library   Library  @relation(fields: [libraryId], references: [id], onDelete: Cascade)
  branch    Branch   @relation(fields: [branchId], references: [id], onDelete: Cascade)
  student   Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  plan      Plan     @relation(fields: [planId], references: [id])
  seat      Seat?    @relation(fields: [seatId], references: [id])
  payments  Payment[]
  
  @@map("student_subscriptions")
}

// Seat Management
model Seat {
  id        String   @id @default(uuid())
  libraryId String
  branchId  String
  number    String
  section   String?
  row       String?
  column    String?
  status    String   // 'available', 'occupied', 'maintenance', 'reserved'
  type      String?  // 'standard', 'premium', 'cubicle'
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relationships
  library   Library  @relation(fields: [libraryId], references: [id], onDelete: Cascade)
  branch    Branch   @relation(fields: [branchId], references: [id], onDelete: Cascade)
  subscriptions StudentSubscription[]
  
  @@unique([branchId, number])
  @@map("seats")
}

// Attendance Record
model Attendance {
  id        String   @id @default(uuid())
  libraryId String
  branchId  String
  studentId String
  date      DateTime // YYYY-MM-DD
  checkIn   DateTime
  checkOut  DateTime?
  duration  Int?     // in minutes
  status    String   // 'present', 'absent', 'late', 'half_day'
  method    String?  // 'qr', 'manual', 'biometric'
  verifiedBy String? // Staff ID if manual
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relationships
  library   Library  @relation(fields: [libraryId], references: [id], onDelete: Cascade)
  branch    Branch   @relation(fields: [branchId], references: [id], onDelete: Cascade)
  student   Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  
  @@index([studentId, date])
  @@index([branchId, date])
  @@map("attendance")
}

// Staff Attendance Record
model StaffAttendance {
  id        String   @id @default(uuid())
  libraryId String
  branchId  String
  staffId   String
  date      DateTime // YYYY-MM-DD
  checkIn   DateTime
  checkOut  DateTime?
  duration  Int?     // in minutes
  status    String   // 'present', 'absent', 'late', 'half_day'
  method    String?  // 'qr', 'manual'
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relationships
  library   Library  @relation(fields: [libraryId], references: [id], onDelete: Cascade)
  branch    Branch   @relation(fields: [branchId], references: [id], onDelete: Cascade)
  staff     Staff    @relation(fields: [staffId], references: [id], onDelete: Cascade)
  
  @@index([staffId, date])
  @@map("staff_attendance")
}

// Staff Shift (For scheduling)
model StaffShift {
  id        String   @id @default(uuid())
  libraryId String
  branchId  String
  staffId   String
  dayOfWeek Int      // 0-6 (Sun-Sat)
  startTime String   // HH:mm
  endTime   String   // HH:mm
  isActive  Boolean  @default(true)
  
  // Relationships
  library   Library  @relation(fields: [libraryId], references: [id], onDelete: Cascade)
  branch    Branch   @relation(fields: [branchId], references: [id], onDelete: Cascade)
  staff     Staff    @relation(fields: [staffId], references: [id], onDelete: Cascade)

  @@map("staff_shifts")
}

// Payment Transaction
model Payment {
  id        String   @id @default(uuid())
  libraryId String
  branchId  String
  studentId String
  
  // Relations to other entities
  subscriptionId String?
  feeId     String? 
  
  // Flexible relation fields used by application logic
  type      String   // 'subscription', 'fee'
  relatedId String?  // ID of Plan, Subscription, or Fee
  
  amount    Float
  method    String   // 'razorpay', 'cashfree', 'upi_app', 'qr_code', 'front_desk'
  status    String   // 'pending', 'pending_verification', 'completed', 'failed', 'refunded'
  
  description String?
  notes       String?
  
  // Gateway Details
  gatewayProvider   String?
  gatewayOrderId    String?
  gatewayPaymentId  String?
  gatewaySignature  String?
  
  // Manual Payment Details
  proofUrl    String?
  
  // Promotion Details
  promotionId    String?
  discountAmount Float?
  
  transactionId String?
  invoiceNo String?  @unique
  date      DateTime @default(now())
  collectedBy String? // Staff ID
  verifiedBy  String?
  verifierRole String?
  verifiedAt  DateTime?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relationships
  library   Library  @relation(fields: [libraryId], references: [id], onDelete: Cascade)
  branch    Branch   @relation(fields: [branchId], references: [id], onDelete: Cascade)
  student   Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  subscription StudentSubscription? @relation(fields: [subscriptionId], references: [id])
  additionalFee AdditionalFee? @relation(fields: [feeId], references: [id])
  promotion     Promotion? @relation(fields: [promotionId], references: [id])
  
  @@map("payments")
}

// Student Wallet
model StudentWallet {
  id        String   @id @default(uuid())
  libraryId String
  studentId String
  balance   Float    @default(0)
  currency  String   @default("INR")
  status    String   @default("active")
  updatedAt DateTime @updatedAt
  
  // Relationships
  library   Library  @relation(fields: [libraryId], references: [id], onDelete: Cascade)
  student   Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  transactions WalletTransaction[]
  
  @@unique([libraryId, studentId])
  @@map("student_wallets")
}

// Wallet Transaction
model WalletTransaction {
  id        String   @id @default(uuid())
  libraryId String
  walletId  String
  amount    Float
  type      String   // 'credit', 'debit'
  reason    String   // 'recharge', 'payment', 'refund'
  referenceId String? // Payment ID or Subscription ID
  createdAt DateTime @default(now())
  
  // Relationships
  library   Library  @relation(fields: [libraryId], references: [id], onDelete: Cascade)
  wallet    StudentWallet @relation(fields: [walletId], references: [id], onDelete: Cascade)
  
  @@map("wallet_transactions")
}

// Promotion/Coupon
model Promotion {
  id        String   @id @default(uuid())
  libraryId String
  branchId  String?  // Optional: specific to branch
  planId    String?  // Optional: specific to plan
  code      String   @unique
  description String?
  discountType String // 'percentage', 'fixed'
  discountValue Float
  minOrderValue Float?
  maxDiscount   Float?
  startDate     DateTime
  endDate       DateTime
  isActive      Boolean  @default(true)
  usageLimit    Int?     // Total global usage limit
  perUserLimit  Int?     // Limit per student
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  // Relationships
  library   Library  @relation(fields: [libraryId], references: [id], onDelete: Cascade)
  branch    Branch?  @relation(fields: [branchId], references: [id], onDelete: Cascade)
  plan      Plan?    @relation(fields: [planId], references: [id], onDelete: Cascade)
  payments  Payment[]
  
  @@map("promotions")
}

// Support Ticket
model SupportTicket {
  id        String   @id @default(uuid())
  libraryId String
  studentId String?
  staffId   String?  // Created by staff
  branchId  String?  // Associated branch
  subject   String
  description String
  priority  String   // 'low', 'medium', 'high', 'urgent'
  status    String   // 'open', 'in_progress', 'resolved', 'closed'
  category  String   // 'payment', 'wifi', 'cleaning', 'other'
  attachmentUrl String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relationships
  library   Library  @relation(fields: [libraryId], references: [id], onDelete: Cascade)
  branch    Branch?  @relation(fields: [branchId], references: [id], onDelete: Cascade)
  student   Student? @relation(fields: [studentId], references: [id], onDelete: Cascade)
  staff     Staff?   @relation(fields: [staffId], references: [id], onDelete: Cascade)
  comments  TicketComment[]
  
  @@map("support_tickets")
}

model TicketComment {
  id        String   @id @default(uuid())
  ticketId  String
  userId    String   // Student ID or Staff ID or Owner ID
  userType  String   // 'student', 'staff', 'owner'
  content   String
  createdAt DateTime @default(now())
  
  // Relationships
  ticket    SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  library   Library       @relation(fields: [libraryId], references: [id], onDelete: Cascade)
  libraryId String // For multi-tenancy context
  
  @@map("ticket_comments")
}

// Announcement
model Announcement {
  id        String   @id @default(uuid())
  libraryId String
  branchId  String?  // Optional: specific to branch
  title     String
  content   String
  type      String   // 'info', 'warning', 'success'
  target    String   // 'all', 'students', 'active_students', 'staff'
  expiresAt DateTime?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  
  // Relationships
  library   Library  @relation(fields: [libraryId], references: [id], onDelete: Cascade)
  
  @@map("announcements")
}

// Student Goal (Gamification)
model StudentGoal {
  id        String   @id @default(uuid())
  libraryId String
  studentId String
  title     String
  targetHours Int    // Target study hours
  deadline  DateTime?
  progress  Int      @default(0) // Current hours
  status    String   // 'active', 'completed', 'failed'
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relationships
  library   Library  @relation(fields: [libraryId], references: [id], onDelete: Cascade)
  student   Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  
  @@map("student_goals")
}

// Focus Session (Pomodoro/Timer logs)
model FocusSession {
  id        String   @id @default(uuid())
  libraryId String
  studentId String
  startTime DateTime
  endTime   DateTime?
  duration  Int?     // in minutes
  label     String?  // Subject/Task
  rating    Int?     // 1-5 focus rating
  createdAt DateTime @default(now())
  
  // Relationships
  library   Library  @relation(fields: [libraryId], references: [id], onDelete: Cascade)
  student   Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  
  @@map("focus_sessions")
}
